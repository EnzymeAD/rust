#############################################################
#   WARNING: automatically generated file, DO NOT CHANGE!   #
#############################################################

# This file was automatically generated by the expand-yaml-anchors tool. The
# source file that generated this one is:
#
#   src/ci/github-actions/ci.yml
#
# Once you make changes to that file you need to run:
#
#   ./x.py run src/tools/expand-yaml-anchors/
#
# The CI build will fail if the tool is not run after changes to this file.

---
name: CI

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
  merge_group:

jobs:
  build:
    name: "PR - ${{ matrix.name }}"
    strategy:
      matrix:
        include:
          - name: Build and test Enzyme rust
          - os: ubuntu-latest
          - env: {}
    timeout-minutes: 600
    runs-on: "${{ matrix.os }}"
    steps:
      - name: checkout the source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: add extra environment variables
        run: src/ci/scripts/setup-environment.sh
        env:
          EXTRA_VARIABLES: "${{ toJson(matrix.env) }}"
        if: success() && !env.SKIP_JOB
      - name: build
        run: |
          mkdir build
          cd build
          ../configure --enable-llvm-link-shared --enable-llvm-plugins --enable-llvm-enzyme --release-channel=nightly --enable-llvm-assertions --enable-clang --enable-lld --enable-option-checking --enable-ninja --disable-docs
          ../x.py build --stage 1 library/std library/proc_macro library/test tools/rustdoc
          rustup toolchain link enzyme `pwd`/build/`rustup target list --installed`/stage1
          rustup toolchain install nightly # enables -Z unstable-options
      - name: test
        run: |
          cargo +enzyme test --examples
